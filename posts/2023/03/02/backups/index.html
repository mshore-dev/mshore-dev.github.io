<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Backups, eh? | Michael's Blog</title>
<meta name=keywords content="self-hosting,backups"><meta name=description content="The importance of backups Backups are important. No matter what kind of data you are storing, chances are you will want to have it backed up somewhere. Some data is inconvenient to lose, and some data is devastating to lose. If you have data of any real importance, it should be properly backed up. Hardware can last a long time, but one failure can leave you in quite a predicament."><meta name=author content><link rel=canonical href=https://mshore-dev.github.io/posts/2023/03/02/backups/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://mshore-dev.github.io/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://mshore-dev.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://mshore-dev.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://mshore-dev.github.io/apple-touch-icon.png><link rel=mask-icon href=https://mshore-dev.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://mshore-dev.github.io/posts/2023/03/02/backups/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Backups, eh?"><meta property="og:description" content="The importance of backups Backups are important. No matter what kind of data you are storing, chances are you will want to have it backed up somewhere. Some data is inconvenient to lose, and some data is devastating to lose. If you have data of any real importance, it should be properly backed up. Hardware can last a long time, but one failure can leave you in quite a predicament."><meta property="og:type" content="article"><meta property="og:url" content="https://mshore-dev.github.io/posts/2023/03/02/backups/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-03-02T00:00:00+00:00"><meta property="article:modified_time" content="2023-03-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Backups, eh?"><meta name=twitter:description content="The importance of backups Backups are important. No matter what kind of data you are storing, chances are you will want to have it backed up somewhere. Some data is inconvenient to lose, and some data is devastating to lose. If you have data of any real importance, it should be properly backed up. Hardware can last a long time, but one failure can leave you in quite a predicament."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://mshore-dev.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Backups, eh?","item":"https://mshore-dev.github.io/posts/2023/03/02/backups/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Backups, eh?","name":"Backups, eh?","description":"The importance of backups Backups are important. No matter what kind of data you are storing, chances are you will want to have it backed up somewhere. Some data is inconvenient to lose, and some data is devastating to lose. If you have data of any real importance, it should be properly backed up. Hardware can last a long time, but one failure can leave you in quite a predicament.","keywords":["self-hosting","backups"],"articleBody":"The importance of backups Backups are important. No matter what kind of data you are storing, chances are you will want to have it backed up somewhere. Some data is inconvenient to lose, and some data is devastating to lose. If you have data of any real importance, it should be properly backed up. Hardware can last a long time, but one failure can leave you in quite a predicament.\nBacking up my important data For the past couple of years, I have run a small NextCloud instance for me and a few of my friends. I cannot speak to my friends’ use-case, but I keep relatively important data on my NextCloud instance. The data is not irreplaceable, the complete backup of my camera roll lives on my phone, and the previous semester’s schoolwork is not of super high importance. However, losing that data would be a pain.\nAlthough unlikely, the day my phone ceases to function could also be the day my hosting provider experiences a data-center fire. In this scenario, my data is gone. Even though it is highly unlikely this scenario will happen, it is not impossible. Therefore, it is important to take measures to ensure my data, and the data of my friends, is safely backed up.\nActually backing up data A quick disclaimer: I am not an expert on backup solutions. This is something I put together to fit my simple needs.\nThe first step was finding a tool to facilitate backups in such a way that I could search through the data by date. I specifically wanted to be able to pull files from a certain day’s backup. Since a majority of my data on NextCloud was word documents, the ability to pull a specific version of the file was key. NextCloud does a pretty good job of keeping file versions, but this is an extra layer of security atop that.\nFor this, I landed on restic. Restic is available across a wide variety of operating systems, and is natively compatible with several storage providers. It is also free and open-source software, which is always a plus. Restic handles backups by taking snapshots of the filesystem, de-duplicating, and encrypting the data. The backed-up data is then stored in a local “repository” that can be read from or added to as needed.\nTo facilitate creating backups in my Docker Compose environment, I created a custom Docker image based on Alpine Linux, including Restic, RClone, and crond. By leveraging both Restic and RClone, I am able to have the backup exist both on the server, and on a remote object storage host. The logic of the backup is simple, with a few variations depending on what exactly is being backed up.\nNextCloud Backup The NextCloud backup has the most steps, since it has a “maintenance mode” that can be enabled to ensure data consistency during the backup. The backup script first enables NextCloud’s maintenance mode, then creates a dump of the PostgreSQL database. Afterwards, Restic is used to back up the files from NextCloud and the previously dumped database. Finally, maintenance mode is disabled and the backup repository is synced to Backblaze B2.\nMastodon Backup Mastodon, unlike NextCloud, does not have a maintenance mode. Otherwise, the logic follows the same flow, except with an extra database: Redis. Redis automatically syncs data to a dump.rdb on disk. That file is simply included in the folder to be backed up.\nlldap Backup Last, but certainly not least, is lldap. lldap is a light LDAP implementation I use to have my self-hosted services operate under a single set of credentials. lldap stores its data in an SQLite3 database, so backing it up is a breeze.\nNow you’ve got a backup! Hurray! Now I have a functioning backup system. It has been running for the past month without issue. However, there is one final issue: restoring from the backup. Thankfully, I have not yet had an incident requiring this. However, a backup does no good if you cannot restore from it. Preliminary testing has proven data can be retrieved from the backup, but I have not yet tried it in a “real-world scenario”. Over the next few weeks, I intend to investigate and come up with a procedure for restoring data, in the event it is required.\n","wordCount":"717","inLanguage":"en","datePublished":"2023-03-02T00:00:00Z","dateModified":"2023-03-02T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://mshore-dev.github.io/posts/2023/03/02/backups/"},"publisher":{"@type":"Organization","name":"Michael's Blog","logo":{"@type":"ImageObject","url":"https://mshore-dev.github.io/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://mshore-dev.github.io/ accesskey=h title="Michael's Blog (Alt + H)">Michael's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Backups, eh?</h1><div class=post-meta>&lt;span title='2023-03-02 00:00:00 +0000 UTC'>March 2, 2023&lt;/span></div></header><div class=post-content><h2 id=the-importance-of-backups>The importance of backups<a hidden class=anchor aria-hidden=true href=#the-importance-of-backups>#</a></h2><p>Backups are important. No matter what kind of data you are storing, chances are you will want to have it backed up somewhere. Some data is inconvenient to lose, and some data is devastating to lose. If you have data of any real importance, it should be properly backed up. Hardware can last a long time, but one failure can leave you in quite a predicament.</p><h2 id=backing-up-my-important-data>Backing up my important data<a hidden class=anchor aria-hidden=true href=#backing-up-my-important-data>#</a></h2><p>For the past couple of years, I have run a small NextCloud instance for me and a few of my friends. I cannot speak to my friends&rsquo; use-case, but I keep relatively important data on my NextCloud instance. The data is not irreplaceable, the complete backup of my camera roll lives on my phone, and the previous semester&rsquo;s schoolwork is not of super high importance. However, losing that data would be a pain.</p><p>Although unlikely, the day my phone ceases to function could also be the day my hosting provider experiences a data-center fire. In this scenario, my data is <em>gone</em>. Even though it is highly unlikely this scenario will happen, it is not impossible. Therefore, it is important to take measures to ensure my data, and the data of my friends, is safely backed up.</p><h2 id=actually-backing-up-data>Actually backing up data<a hidden class=anchor aria-hidden=true href=#actually-backing-up-data>#</a></h2><p>A quick disclaimer: I am not an expert on backup solutions. This is something I put together to fit my simple needs.</p><p>The first step was finding a tool to facilitate backups in such a way that I could search through the data by date. I specifically wanted to be able to pull files from a certain day&rsquo;s backup. Since a majority of my data on NextCloud was word documents, the ability to pull a specific version of the file was key. NextCloud does a pretty good job of keeping file versions, but this is an extra layer of security atop that.</p><p>For this, I landed on <a href=https://restic.net/>restic</a>. Restic is available across a wide variety of operating systems, and is natively compatible with several storage providers. It is also free and open-source software, which is always a plus. Restic handles backups by taking snapshots of the filesystem, de-duplicating, and encrypting the data. The backed-up data is then stored in a local &ldquo;repository&rdquo; that can be read from or added to as needed.</p><p>To facilitate creating backups in my Docker Compose environment, I created <a href=https://github.com/mshore-dev/alpine-cron-backup>a custom Docker image</a> based on Alpine Linux, including Restic, RClone, and <code>crond</code>. By leveraging both Restic and RClone, I am able to have the backup exist both on the server, and on a remote object storage host. The logic of the backup is simple, with a few variations depending on what exactly is being backed up.</p><h3 id=nextcloud-backup>NextCloud Backup<a hidden class=anchor aria-hidden=true href=#nextcloud-backup>#</a></h3><p>The NextCloud backup has the most steps, since it has a &ldquo;maintenance mode&rdquo; that can be enabled to ensure data consistency during the backup. The backup script first enables NextCloud&rsquo;s maintenance mode, then creates a dump of the PostgreSQL database. Afterwards, Restic is used to back up the files from NextCloud and the previously dumped database. Finally, maintenance mode is disabled and the backup repository is synced to Backblaze B2.</p><h3 id=mastodon-backup>Mastodon Backup<a hidden class=anchor aria-hidden=true href=#mastodon-backup>#</a></h3><p>Mastodon, unlike NextCloud, does not have a maintenance mode. Otherwise, the logic follows the same flow, except with an extra database: Redis. Redis automatically syncs data to a <code>dump.rdb</code> on disk. That file is simply included in the folder to be backed up.</p><h3 id=lldap-backup>lldap Backup<a hidden class=anchor aria-hidden=true href=#lldap-backup>#</a></h3><p>Last, but certainly not least, is <a href=https://github.com/nitnelave/lldap>lldap</a>. lldap is a light LDAP implementation I use to have my self-hosted services operate under a single set of credentials. lldap stores its data in an SQLite3 database, so backing it up is a breeze.</p><h2 id=now-youve-got-a-backup>Now you&rsquo;ve got a backup!<a hidden class=anchor aria-hidden=true href=#now-youve-got-a-backup>#</a></h2><p>Hurray! Now I have a functioning backup system. It has been running for the past month without issue. However, there is one final issue: restoring from the backup. Thankfully, I have not yet had an incident requiring this. However, a backup does no good if you cannot restore from it. Preliminary testing has proven data can be retrieved from the backup, but I have not yet tried it in a &ldquo;real-world scenario&rdquo;. Over the next few weeks, I intend to investigate and come up with a procedure for restoring data, in the event it is required.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://mshore-dev.github.io/tags/self-hosting/>Self-Hosting</a></li><li><a href=https://mshore-dev.github.io/tags/backups/>Backups</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://mshore-dev.github.io/>Michael's Blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>